import asyncio
from telegram import Bot
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
import os, time, requests, hashlib
from PIL import Image
from io import BytesIO
from datetime import datetime, timedelta

TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN')
CHAT_ID = os.environ.get('CHAT_ID')
HISTORY_FILE = 'last_image_hash.txt'
TIME_FILE = 'last_run_time.txt'

async def send_telegram(photo_bytes):
    bot = Bot(token=TELEGRAM_TOKEN)
    img = Image.open(BytesIO(photo_bytes))
    # ê¸€ìê°€ ë˜‘ë°”ë¡œ ë³´ì´ë„ë¡ 270ë„ íšŒì „
    rotated_img = img.rotate(270, expand=True) 
    temp_photo = "menu.jpg"
    rotated_img.save(temp_photo, quality=95)
    await bot.send_photo(chat_id=CHAT_ID, photo=open(temp_photo, 'rb'), caption="ğŸ± ì´ë²ˆ ì£¼ ì‹ë‹¨í‘œì…ë‹ˆë‹¤!")
    os.remove(temp_photo)

def run_check():
    # í•œêµ­ ì‹œê°„ ê¸°ë¡
    kst_now = (datetime.utcnow() + timedelta(hours=9)).strftime('%Y-%m-%d %H:%M:%S')
    with open(TIME_FILE, 'w', encoding='utf-8') as f:
        f.write(f"ìµœì¢… ì‹¤í–‰ ì‹œê°„(KST): {kst_now}")

    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

    try:
        driver.get("https://pf.kakao.com/_sixfwG/posts")
        time.sleep(7)
        # ìƒì„¸ ì£¼ì†Œ ì¶”ì¶œ
        links = driver.find_elements(By.TAG_NAME, "a")
        detail_url = next((l.get_attribute('href') for l in links if "/_sixfwG/" in str(l.get_attribute('href')) and any(c.isdigit() for c in str(l.get_attribute('href')))), None)
        
        if detail_url:
            driver.get(detail_url)
            time.sleep(5)
            img_url = driver.find_element(By.XPATH, '//meta[@property="og:image"]').get_attribute('content')
            img_data = requests.get(img_url).content
            curr_hash = hashlib.md5(img_data).hexdigest()

            last_hash = open(HISTORY_FILE, 'r').read().strip() if os.path.exists(HISTORY_FILE) else ""

            if curr_hash != last_hash:
                asyncio.run(send_telegram(img_data))
                with open(HISTORY_FILE, 'w') as f: f.write(curr_hash)
                print("ìƒˆ ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ")
            else:
                print("ë³€ê²½ ì‚¬í•­ ì—†ìŒ")
    finally:
        driver.quit()

if __name__ == "__main__":
    run_check()
